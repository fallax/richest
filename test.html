<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Viz</title>
  	<script src="periodic.js"></script>
	<script src="lib/coffee-script.js"></script>
	<script src="lib/jquery-2.1.1.min.js"></script>
	<script type="text/coffeescript" src="canvas.coffee"></script>
  <script type="text/literate-coffeescript" src="viewport.litcoffee"></script>
  <script type="text/coffeescript">
  	
    window.startTime = 0
    window.renderTime = 0

    # sane version of mod (JS one is NOT nice...)
    Number::mod = (n) -> ((this % n) + n) % n

    redraw = (bounds) ->
      gap = 50

      startX = Math.floor(bounds[0]/50) * 50
      startY = Math.floor(bounds[1]/50) * 50
      for x in [startX..bounds[2]] by gap
        for y in [startY..bounds[3]] by gap
          odd = (((x/50 + y/50).mod 2) is 0)
          canvasContext.fillStyle = if odd then "white" else "AliceBlue"
          canvasContext.fillRect x, y, 50, 50
          canvasContext.fillStyle = "CornflowerBlue"
          canvasContext.fillText "" + x + "," + y, x + 5, y + 28

    view = viewport()

    window.animate = () ->
      blankCanvas()
      transformContext view, canvasContext
      renderStart = (new Date()).getTime()
      redraw getBounds view
      renderTime += (new Date()).getTime() - renderStart
      now = (new Date()).getTime()
      canvasContext.setTransform 1, 0, 0, 1, 0, 0
      canvasContext.fillStyle = "black"
      elapsed = (now - window.startTime) 
      canvasContext.fillText "Elapsed: " + elapsed + " Rendering: " + renderTime + " (" + (renderTime * 100 / elapsed).toFixed(1) + "%)", 20, 20

    last = [0, 0]
    dragging = false

    $ () ->

      console.log "loaded"

      makeCanvas()
      blankCanvas()

      window.startTime = (new Date()).getTime()

      animate()

      window.setInterval "animate();", 20

      $(document).on "mousedown mouseup mousemove", (e) ->
        switch e.type
          when "mousemove"
            if dragging
              pos = getPos(view, e.pageX, e.pageY)
              if (last[0] isnt pos[0]) or (last[1] isnt pos[1])
                view.camX += last[0] - pos[0]
                view.camY += last[1] - pos[1]
                last = getPos(view, e.pageX, e.pageY)
          when "mousedown"
            last = getPos(view, e.pageX, e.pageY)
            dragging = true
          when "mouseup"
            dragging = false

  </script>
</head>
<body>
</body>
</html>